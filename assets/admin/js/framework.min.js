/*! FUNimation 2014-10-02 10:09:23 */
function initFormField(a,b,c,d){if("upload"===b.type&&(c=$(c[1])),c.attr("id",d.field_key),c.attr("name",d.field_name),b.attr)for(var e in b.attr)c.attr(b.attr[e].name,b.attr[e].value);if("dropdown"==b.type&&c.is("select")&&b.values)for(var f in b.values){var g=b.values[f],h=$("<option/>");h.attr("value",g.id),h.text(g.name),c.append(h)}return"composite"==b.type||"multiple"==b.type?(c.attr("name",d.field_name+"[]"),b.validation&&"hidden"!=b.type&&(a.rules[d.field_name+"[]"]=b.validation.rules,a.messages[d.field_name+"[]"]=b.validation.messages)):b.validation&&(a.rules[d.field_name]=b.validation.rules,a.messages[d.field_name]=b.validation.messages),a}function buildFromTemplate(a,b,c){var d;if(c&&c.template||c&&c.form_template)str=c.template?c.template:c.form_template?c.form_template:"",d=$(str);else{if(!master_template[b])return!1;d=$(master_template[b]),"label"!=b&&"field"!=b&&"tr"!=b&&"td"!=b&&"th"!=b&&"thead"!=b&&"tbody"!=b&&"tfoot"!=b&&"button"!=b&&"<"!=b&&a&&"grid"==b&&d.addClass(a.table_name)}return d}function lang(a){return language[a]?language[a]:a}function resetForm(a,b){if(a[0].reset(),b)for(var c in b.widgets)b.widgets[c].reset();a.find(".help-inline").remove()}function ajax(a){jQuery.ajax({url:a.url,type:"POST",data:a.data,async:a.async?a.async:!0,cache:!1,beforeSend:function(){return a.beforeSend?a.beforeSend():""},success:function(b){return b.logged&&b.logged===!1?void location.reload():a.success?a.success(b):""},error:function(){a.success("",!0)}})}function initInlineModules(a,b){if(a.inline={},a.containers.form)for(var c in a.model.fields){var d=a.model.fields[c];if(d.type&&"inline"===d.type){var e={model:d.model,settings:{container:b.container},containers:{form:{settings:{validation:"default"}},modal:{},grid:{},toolbar:{settings:{actions:[{type:"button",title:lang(lang("New "+d.model.table_name)),action:"new"}]}}}};e.containers.form=new containers.form(d.model,e.containers,e,a,c).init(),e.containers.modal=new containers.modal(d.model,e.containers,e,a,c).init(),e.containers.grid=new containers.inline(d.model,e.containers,e,a,c).init(),e.containers.toolbar=new containers.toolbar(d.model,e.containers,e,a,c).init(),a.containers.form.fields[c].append(e.containers.toolbar.element),a.containers.form.fields[c].append(e.containers.grid.element),$(b.container).append(e.containers.modal.element),a.inline[c]=e,initInlineModules(e,b)}}}var BASE_URL,master_template={},modules={},language={},moduleManager,modalIndex=100,sidebar;master_template.label="<label/>",master_template.hidden='<input type="hidden"/>',master_template.text='<input type="text"/>',master_template.textarea="<textarea/>",master_template.editor="<textarea/>",master_template.date='<input type="text"/>',master_template.datetime='<input type="datetime"/>',master_template.map='<div><input type="text" class="search full-width" placeholder="'+lang("Address")+'"/><input type="hidden" class="lat" /><input type="hidden" class="lon" /><div class="map" /></div>',master_template.email='<input type="email"/>',master_template.password='<input type="password"/>',master_template.upload='<div class="dropzone"><div class="dz-default dz-message"><span>'+lang("Drop files here to upload")+'</span></div></div><input type="hidden" />',master_template.mask='<input type="text"/>',master_template.dropdown="<select/>",master_template.multiple='<select multiple="multiple"/>',master_template.composite='<select multiple="composite"/>',master_template.daterange='<input type="text"/>',master_template.submit='<input class="btn btn-primary btn-large btn-block" type="submit"/>',master_template.button='<a class="btn btn-primary btn-large btn-block"/>',master_template.field='<div class="control-group"/>',master_template.field_footer='<div class="control-group center"/>',master_template.form='<form autocomplete="off"></form>',master_template.modal='<div class="modal"><div class="modal-box"><div class="modal-container"><div class="modal-border"><div class="modal-header"><h1 class="title"></h1></div><div class="modal-content"></div></div></div></div></div>',master_template.grid='<div class="grid-container"><table class="grid" cellpadding="0" cellspacing="0"/></div>',master_template.grid_inline='<table class="grid" cellpadding="0" cellspacing="0"/>',master_template.row="<tr />",master_template.module='<div class="module"/>',master_template.thead="<thead/>",master_template.tbody="<tbody/>",master_template.tfoot="<tfoot/>",master_template.td="<td/>",master_template.th="<th/>",master_template.tr="<tr/>",master_template.action='<button class="btn btn-primary btn-large btn-block"><i class="icon "></i>Delete</button>',master_template.external='<div class="external"/>',master_template.message='<div class="message"><h3 class="title"></h3></div>',master_template.tabs_container="<div />",master_template.tabs='<ul class="tabs" />',master_template.tab='<li class="tab_content"><a class="title"></a></li>',master_template.tab_content='<div class="tab" />',master_template.field_group='<div class="field-group"><h3 class="title"></h3></div>',master_template.field_column='<div class="field-column"/>',master_template.sidebar_menu='<ul class="menu"><li class="group"><a class="text"></a></li></ul>',master_template.sidebar_row='<li class="menu"><a class="text"></a></li>',master_template.sidebar_icon='<i class="arrow icon fa fa-chevron-right"></i>',master_template.sidebar_arrow='<i class="arrow icon fa fa-chevron-right"></i>',master_template.toolbar='<div class="toolbar"/>',master_template.a="<a/>",master_template.inline="<div/>",master_template.h1="<h1/>",master_template.h2="<h2/>",master_template.h3="<h3/>",master_template.h4="<h4/>",master_template.h5="<h5/>",master_template.div="<div/>",master_template.radio="<div/>",master_template.checkbox="<div/>",master_template.pagination="<div/>";var widgets={},containers={},validation={};$.validator.setDefaults({ignore:""}),validation["default"]={rules:{},messages:{},errorClass:"help-inline",errorElement:"span",highlight:function(a){$(a).closest(".help-inline").removeClass("ok"),$(a).closest(".control-group").removeClass("success").addClass("error")},unhighlight:function(a){$(a).closest(".control-group").removeClass("error")},success:function(a){return a.addClass("valid").addClass("help-inline ok").closest(".control-group").removeClass("error").addClass("success"),!1},submitHandler:function(a){return $(a).find(".alert-success").show(),$(a).find(".alert-error").hide(),!1},invalidHandler:function(a){return $(a.currentTarget).find(".alert-success").hide(),$(a.currentTarget).find(".alert-error").show(),!1}},validation.login={rules:{},messages:{},errorClass:"help-inline",errorElement:"div",highlight:function(a){$(a).closest(".help-inline").removeClass("ok"),$(a).closest(".control-group").removeClass("success").addClass("error")},unhighlight:function(a){$(a).closest(".control-group").removeClass("error")},success:function(a){a.addClass("valid").addClass("help-inline ok").closest(".control-group").removeClass("error").addClass("success")},submitHandler:function(a){$(a).find(".alert-success").show(),$(a).find(".alert-error").hide()},invalidHandler:function(a){$(a.currentTarget).find(".alert-success").hide(),$(a.currentTarget).find(".alert-error").show()}};var datepickerConfig={format:"YYYY-MM-DD",separator:"-",language:"auto",startOfWeek:"sunday",getValue:function(){return this.value},setValue:function(a){this.value=a},startDate:!1,endDate:new Date,minDays:0,maxDays:0,showShortcuts:!0,time:{enabled:!1},shortcuts:{"next-days":[3,5,7],next:["week","month","year"]},customShortcuts:[],inline:!1,container:"body",alwaysOpen:!1,singleDate:!1,batchMode:!1},datepickerConfigSingle={format:"YYYY-MM-DD",autoClose:!0,singleDate:!0,showShortcuts:!1};widgets.daterange=function(a){return this.init=function(){return a.dateRangePicker(datepickerConfig),this},this.reset=function(){},this},widgets.date=function(a){return this.init=function(){return a.dateRangePicker(datepickerConfigSingle),this},this.reset=function(){},this.setValue=function(){},this},widgets.upload=function(a,b,c,d){var e=this;return this.dropzone=void 0,this.field_key="",this.firstTime=!0,this.value="",this.allValues={},this.init=function(){if(void 0===e.dropzone){var d=b.id?b.id:b.key;e.field_key=b.id?b.id:c.table_name+"_"+d;{b.id?b.id:c.table_name+"["+d+"]"}return $(a).dropzone({paramName:b.key,url:b.settings.url,addRemoveLinks:!0,maxFiles:1,init:function(){return this.on("removedfile",function(){$("#"+e.field_key).val("")}),this.on("sending",function(a,b,c){e.xhr=b,fileName=e.xhr.response,$("#"+e.field_key).val(fileName),c.append("name",fileName)}),this.on("complete",function(a){"error"===a.status||(fileName=e.xhr.response,$("#"+e.field_key).val(fileName))}),void 0===e.dropzone&&(e.dropzone=this),this},sending:function(){e.dropzone.options.params=e.getParams()}}),this}return this},this.reset=function(){e.dropzone.removeAllFiles(!0)},this.setValue=function(a){e.dropzone.options.params=e.getParams(),e.dropzone.removeAllFiles(!0),$("#"+e.field_key).val(a);var c=e.getParams();c.field=b.key,c.value=a,$.post(b.settings.url,c,function(a){if(e.dropzone.removeAllFiles(!0),a)$.each(a,function(a,c){var d={name:c.name,size:c.size,type:"image"};e.dropzone.addFile(d,!0),e.dropzone.options.thumbnail.call(e.dropzone,d,BASE_URL+"../helpers/timthumb.php?width=48&height=48&src="+b.settings.download+c.name)});else for(var c in e.dropzone.files)e.dropzone.removeFile(files[c])})},e.getParams=function(){{var a=d.containers.form.element.serializeArray(),b={};new FormData}for(var e in a){var f=a[e];b[f.name.replace(c.table_name,"").replace("[","").replace("]","")]=f.value}return b},this},widgets.map=function(a,b,c){var d=this;return this.map=void 0,d.geocoder=void 0,this.field_key="",this.initAfterShow=!0,this.value="",this.markers=[],this.fields={},this.init=function(){if(void 0===d.map){var e=b.id?b.id:b.key;d.field_key=b.id?b.id:c.table_name+"_"+e;{b.id?b.id:c.table_name+"["+e+"]"}d.fields.latitude=a.find(".lat"),d.fields.longitude=a.find(".lon"),d.fields.latitude.attr("name",c.table_name+"["+b.settings.lat_key+"]"),d.fields.longitude.attr("name",c.table_name+"["+b.settings.lon_key+"]"),setTimeout(d.initDelayed,200)}return this},this.initDelayed=function(){var e=b.id?b.id:b.key;d.field_key=b.id?b.id:c.table_name+"_"+e;b.id?b.id:c.table_name+"["+e+"]";return d.map=new google.maps.Map(a.find(".map")[0],{center:new google.maps.LatLng(b.settings.center.latitude,b.settings.center.longitude),zoom:b.settings.zoom,mapTypeId:google.maps.MapTypeId.ROADMAP}),d.geocoder=new google.maps.Geocoder,a.find(".search").unbind("change").on("change",function(){return d.geocodeAddress($(this).val()),!1}),a.find(".search").keypress(function(a){return 13==a.which?(d.geocodeAddress($(this).val()),!1):void 0}),google.maps.event.addListener(d.map,"click",function(a){d.removeAllMarkers(),d.addMarker(a.latLng)}),d.setValue(d.value),this},this.geocodeAddress=function(a){d.value="",void 0!=d.map&&(d.removeAllMarkers(),d.geocoder.geocode({address:a},function(a,c){if(c==google.maps.GeocoderStatus.OK){var e=a[0].geometry.location;d.map.setCenter(e),d.map.setZoom(b.settings.zoom),d.addMarker(e)}else alert(lang("Address not found"))}))},this.reset=function(){d.value="",d.removeAllMarkers(),void 0!=d.map&&(d.map.setCenter(new google.maps.LatLng(b.settings.center.latitude,b.settings.center.longitude)),d.map.setZoom(b.settings.zoom))},this.setValue=function(a){if(this.value=a,d.removeAllMarkers(),void 0!=d.map)if(google.maps.event.trigger(d.map,"resize"),a&&a.latitude&&d.value.latitude!==b.settings.center.latitude&&d.value.longitude!==b.settings.center.longitude){var c=new google.maps.LatLng(d.value.latitude,d.value.longitude);d.map.setCenter(c),d.map.setZoom(b.settings.zoom),d.addMarker(c)}else{var c=new google.maps.LatLng(b.settings.center.latitude,b.settings.center.longitude);d.map.setCenter(c),d.map.setZoom(b.settings.zoom),d.addMarker(c)}},this.addMarker=function(a){d.fields.latitude.val(a.lat()),d.fields.longitude.val(a.lng());var b=new google.maps.Marker({map:d.map,title:"move this marker",position:a,animation:google.maps.Animation.DROP,draggable:!0});google.maps.event.addListener(b,"dragend",function(a){d.fields.latitude.val(a.latLng.lat()),d.fields.longitude.val(a.latLng.lng())}),d.markers.push(b)},this.removeAllMarkers=function(){for(var a in d.markers)d.markers[a].setMap(null);d.markers=[]},this},widgets.editor=function(a,b,c){var d=this;return this.editor=void 0,this.field_key="",this.firstTime=!0,this.init=function(){if(void 0===d.editor){var e=b.id?b.id:b.key;d.field_key=b.id?b.id:c.table_name+"_"+e;{b.id?b.id:c.table_name+"["+e+"]"}return d.editor=a.editable({inlineMode:!1,borderColor:"#ececec",width:"484px",imageUploadURL:b.settings.url,imageUploadParams:{field:b.key}}),this}return this},this.reset=function(){$(a).editable("setHTML","",!1)},this.setValue=function(b){$(a).editable("setHTML",b,!1)},this},widgets.pagination=function(a,b){var c=this;return this.pagination=void 0,this.firstTime=!0,this.init=function(){return void 0===c.pagination?(c.settings={},c.settings.itemsOnPage=b.per_page,c.settings.cssStyle="light-theme",c.settings.onPageClick=function(a){return b.onChange(a),!1},a.pagination(c.settings),this):this},this.setValue=function(b){a.pagination("updateItems",b.total)},this},widgets.tabs=function(a){return this.init=function(){return a.idTabs(),this},this.reset=function(){var b=a.find(".tabs .title.selected");$(b.attr("href")).hide(),b.removeClass("selected")},this},containers.form=function(a,b,c){this.element=buildFromTemplate(a,"form",b.form.settings),this.fields={},this.buttons={},this.widgets={};var d=this;return this.init=function(){d.validation_params={rules:{},messages:{}},d.validation_params=b.form.settings.validation?validation[b.form.settings.validation]:validation["default"];var e,f=buildFromTemplate(a,"field_column"),g=buildFromTemplate(a,"field_group"),h="",i="",j="",k=buildFromTemplate("","tabs_container");d.element.append(k),current_tab=buildFromTemplate(a,"tab_content"),current_tab.attr("id",a.table_name+"_tab_default"),k.append(current_tab),d.tabs=[];for(var l in a.field_group.form){var m=!1;e=a.fields[a.field_group.form[l]];var n=e.id?e.id:e.key,o=e.id?e.id:a.table_name+"_"+n,p=e.id?e.id:a.table_name+"["+n+"]";if(e.tab&&(m=!0,current_tab=buildFromTemplate(a,"tab_content"),current_tab.attr("id",a.table_name+"_tab_"+n),d.tabs.push({id:a.table_name+"_tab_"+n,title:e.tab}),k.append(current_tab)),e){var q=buildFromTemplate(a,e.type,e,e.key);if(q){if(j=buildFromTemplate(a,"field"),"hidden"===e.type||e.form_template){if("hidden"==e.type)q.attr("name",p),d.validation_params=initFormField(d.validation_params,e,q,{field_id:n,field_name:p,field_key:o}),d.fields[n]=q;else if(e.form_template){q.find(o);var r=q.find("#"+o);d.validation_params=initFormField(d.validation_params,e,r,{field_id:n,field_name:p,field_key:o}),d.fields[n]=r}}else{if(e.label!==!1&&""!==$.trim(e.name)){var s=buildFromTemplate(a,"label",e);s.text(e.name),s.attr("for",o),j.append(s)}d.validation_params=initFormField(d.validation_params,e,q,{field_id:n,field_name:p,field_key:o}),d.fields[n]=q}"hidden"===e.type?d.element.append(q):j.append(q),e.group?((h!=e.group||m)&&(f=buildFromTemplate(a,"field_column"),current_tab.append(f),h=e.group),e.field_group?((i!=e.field_group||m)&&(g=buildFromTemplate(a,"field_group"),g.find(".title").text(e.field_group),i=e.field_group),g.append(j),f.append(g)):f.append(j)):e.field_group?((i!=e.field_group||m)&&(g=buildFromTemplate(a,"field_group"),g.find(".title").text(e.field_group),current_tab.append(g),i=e.field_group),g.append(j)):current_tab.append("hidden"===e.type?q:j)}}}if(d.tabs.length>1){var t=buildFromTemplate("","tabs");for(var u in d.tabs){var v=d.tabs[u],w=buildFromTemplate("","tab");w.find(".title").attr("href","#"+v.id),w.find(".title").text(v.title),t.append(w)}k.prepend(t),d.widgets.tabs=new widgets.tabs(k),d.widgets.tabs.init()}if(j=buildFromTemplate("","field_footer"),j.addClass("modal-footer"),!b.form.settings||b.form.settings&&!b.form.settings.buttons){var x=buildFromTemplate(a,"submit",{}),y=buildFromTemplate(a,"button",{});x.attr("value",lang("Send")),y.text(lang("Cancel")),x.attr("url",a.base_url+a.table_name+"/save"),x.on("click",d.saveCustom),d.buttons.submit=x,d.buttons.cancel=y,j.append(x).append(y)}else for(var z in b.form.settings.buttons){var A=b.form.settings.buttons[z],B=buildFromTemplate(a,"button",{});B.text(A.value),B.attr("url",A.url),j.append(B),B.on("click",d.saveCustom),d.buttons[A.key]=B}for(var u in d.fields){var C=d.fields[u];if(e=a.fields[u],e.key_depending&&C.on("change",d.loadDepends),e.value)C.val(e.value);else if(e.values){var D,E,F;if("radio"==e.type){C.find("*").remove(),C.html("");for(var G in e.values)D=e.values[G],E=$("<label></label>"),F=$('<input type="radio"/>'),F.attr("value",D.id),F.attr("name",C.attr("name")),F.attr("id",C.attr("id")),E.text(D.name),E.attr("for",D.name),E.prepend(F),C.append(E)}else if("checkbox"==e.type){C.find("*").remove(),C.html("");for(var H in e.values)D=e.values[H],E=$("<label></label>"),F=$('<input type="checkbox"/>'),F.attr("value",D.id),F.attr("name",C.attr("name")),F.attr("id",C.attr("id")),E.text(D.name),E.attr("for",D.name),E.prepend(F),C.append(E)}}void 0!==widgets[e.type]&&(d.widgets[u]=new widgets[e.type](C,e,a,c),void 0===d.widgets[u].initAfterShow&&d.widgets[u].init())}return d.element.append(j),d.element.validate(d.validation_params),d},this.loadDepends=function(b){var c=$(b.target),e=c.attr("name");e=e.replace(a.table_name,"").replace("[","").replace("]","").replace("[","").replace("]","");var f=d.element.serializeArray();f.push({name:"key",value:e}),ajax({url:BASE_URL+a.base_url+a.table_name+"/loadDepends",data:f,success:function(a){a.status&&"success"===a.status&&(d.loadData(a,!0),c.trigger("changed"))}})},this.saveCustom=function(a,b){var c=$(this).attr("url");return a&&!a.target&&(c=a),d.element.valid()&&ajax({url:BASE_URL+c,data:d.element.serializeArray(),success:function(c){if(c.status)if("success"===c.status){if(!c.reload)return d.callbackAfterSend(c),$(this).trigger("changed"),$(a.target).trigger("changed"),b?b():"";window.location.href=c.reload}else alert(c.message);else alert(lang("There was a server problem in server: "+c))}}),!1},this.loadData=function(b,c,e){void 0===c&&resetForm(d.element,d);for(var f in d.fields){var g=d.fields[f];if(void 0!==b[a.table_name][f])if(g.is("input")||g.is("textarea")){g.val(b[a.table_name][f]);{a.fields[f]}void 0!==d.widgets[f]&&d.widgets[f].setValue(b[a.table_name][f],b[a.table_name])}else if("dropdown"==a.fields[f].type||"multiple"==a.fields[f].type||"composite"==a.fields[f].type){g.find("*").remove(),g.html("");for(var h in b[a.table_name].dropdown[f]){var i=b[a.table_name].dropdown[f][h],j=$("<option/>");j.attr("value",i.id),j.text(i.name),(i.selected||b[a.table_name][f]==i.id)&&j.attr("selected","selected"),g.append(j)}}else if("inline"==a.fields[f].type){if(e&&e.inline){var k=[];for(var l in b[a.table_name].inline[f])k.push(b[a.table_name].inline[f][l]);e.inline[f].containers.grid.list=k,e.inline[f].containers.grid.refreshOnly()}}else void 0!=d.widgets[f]&&d.widgets[f].setValue(b[a.table_name][f],b[a.table_name])}},this.initAfterShow=function(){for(var a in d.widgets)d.widgets[a].init()},this.callbackAfterSend=function(){},this.remoteLoad=function(){ajax({url:BASE_URL+a.base_url+a.table_name+"/getNew",success:function(a){d.loadData(a)}})},this},containers.grid=function(a,b,c){this.element=buildFromTemplate(a,"grid",b.grid.settings),this.grid=this.element.find(".grid"),this.element.hide();var d=this;return d.widgets={},d.data={per_page:10,current_page:1},d.actions={},this.init=function(){c.containers.form&&c.containers.modal&&(resetForm(c.containers.form.element,c.containers.form),c.containers.modal.element.hide(),c.containers.modal.element.find(".modal-content").append(c.containers.form.element),c.containers.form.callbackAfterSend=function(){c.containers.modal.fadeOut(200),d.refresh()},c.containers.form.buttons.cancel.on("click",function(){return c.containers.modal.fadeOut(200),!1}),c.containers.modal.element.on("click",function(a){a.target==c.containers.modal.element[0]&&c.containers.modal.fadeOut(200)})),d.header=buildFromTemplate(a,"thead"),d.header_row=buildFromTemplate(a,"tr");var e;d.total_columns=0;for(var f in a.field_group.grid){var g=a.field_group.grid[f],h=a.fields[g];h&&(e=buildFromTemplate(a,"th"),e.text(h.name),d.header_row.append(e),d.total_columns++)}if(b.grid.settings&&b.grid.settings.actions&&(e=buildFromTemplate(a,"th"),e.addClass("actions"),e.text(""),d.header_row.append(e),d.total_columns++),$(d.header).append(d.header_row),d.grid.append(d.header),d.tbody=buildFromTemplate(a,"tbody"),d.grid.append(d.tbody),d.external=buildFromTemplate(a,"external"),$(c.settings.container).append(d.external),d.message=buildFromTemplate(a,"message"),!$.isEmptyObject(a.pagination)){d.tfoot=buildFromTemplate(a,"tfoot"),d.grid.append(d.tfoot),d.pagination=buildFromTemplate(a,"pagination"),d.data.per_page=a.pagination.per_page,a.pagination.onChange=function(a){d.data.current_page=a,d.refresh()},d.widgets.pagination=new widgets.pagination(d.pagination,a.pagination).init();var i=buildFromTemplate(a,"td");i.append(d.pagination),i.attr("colspan",d.total_columns),d.tfoot.append(i)}return this},this.refresh=function(){var b={};void 0!==d.pagination&&(b=d.data),ajax({url:BASE_URL+a.base_url+a.table_name+"/getList",data:b,success:function(a){d.loadData(a)},beforeSend:function(){}})},this.loadData=function(c){d.refreshWidgets(c),d.tbody.find("*").remove(),d.tbody.html("");for(var e in c.list){var f,g=c.list[e],h=buildFromTemplate(a,"tr"),i=g[a.table_id];h.attr("id",i);for(var j in a.field_group.grid)if(column=a.field_group.grid[j],a.fields[column]){if(f=buildFromTemplate(a,"td"),g[column])switch(a.fields[column].type){case"email":var k=buildFromTemplate("","a");k.attr("href","mailto:"+g[column]),k.text(g[column]),f.append(k);break;case"upload":var k=$("<img/>");k.attr("src",BASE_URL+"../helpers/timthumb.php?width=48&height=48&src="+a.fields[column].settings.download+g[column]),k.css("width",100),k.css("height","auto"),k.text(g[column]),f.append(k);break;default:f.text(g[column])}h.append(f)}if(b.grid.settings&&b.grid.settings.actions){f=buildFromTemplate(a,"td"),f.addClass("actions");for(var l in b.grid.settings.actions){var m=b.grid.settings.actions[l],n=buildFromTemplate(a,"action");n.attr("action",m.type),n.attr("rel",i),"edit"==m.type?(n.text(lang("Edit")),n.on("click",d.actionButton)):"delete"==m.type?(n.text(lang("Delete")),n.on("click",d.actionButton)):"module"==m.type?(n.attr("module",m.module),n.attr("url",m.url),n.text(m.text),n.on("click",d.actionButton)):(n.attr("url",m.url),n.attr("key",m.key),n.text(m.text),n.on("click",d.actionButton),m.key&&(d.actions[m.key]=m)),f.append(n)}h.append(f)}d.tbody.append(h)}},this.refreshWidgets=function(a){for(var b in d.widgets)d.widgets[b].setValue(a)},this.actionButton=function(){d.actionRow($(this).attr("action"),$(this).attr("rel"),$(this).attr("url"),$(this).attr("module"),$(this).attr("key"))},this.actionRow=function(b,e,f,g,h){for(var i in c.inline)c.inline[i].containers.grid.list=[],c.inline[i].containers.grid.refreshOnly();if(!f)if("new"===b)c.containers.form.element.find(".grid-container").show(),c.containers.modal.element.find(".modal-content").append(c.containers.form.element),resetForm(c.containers.form.element,c.containers.form),c.containers.modal.element.find(".modal-header .title").text(lang("New "+a.table_name)),f=a.base_url+a.table_name+"/getNew";else if("edit"===b)c.containers.form.element.find(".grid-container").show(),c.containers.modal.element.find(".modal-content").append(c.containers.form.element),resetForm(c.containers.form.element,c.containers.form),c.containers.modal.element.find(".modal-header .title").text(lang("Edit "+a.table_name)),f=a.base_url+a.table_name+"/getEdit";else if("delete"===b)f=a.base_url+a.table_name+"/delete";else if("add"===b&&d.actions[h]){f=d.actions[h].model.table_name+"/getNew";var j=d.actions[h],k={model:j.model,settings:[],containers:{modal:{},form:{settings:{}}}};d.moduleLoaded=new Module(k).init(),d.moduleLoaded.containers.modal.element.find(".modal-header .title").text(j.text),d.moduleLoaded.containers.modal.element.find(".modal-content").append(d.moduleLoaded.containers.form.element),d.moduleLoaded.containers.modal.fadeIn(200),d.moduleLoaded.containers.form.callbackAfterSend=function(){d.moduleLoaded.containers.modal.fadeOut(200),d.refresh()},d.moduleLoaded.containers.modal.element.on("click",function(a){a.target==d.moduleLoaded.containers.modal.element[0]&&d.moduleLoaded.containers.modal.fadeOut(200)}),d.moduleLoaded.containers.form.buttons.cancel.on("click",function(){return d.moduleLoaded.containers.modal.fadeOut(200),!1}),d.moduleLoaded.inline={},$(c.settings.container).find(".dinamic-modal").remove(),$(c.settings.container).append(d.moduleLoaded.containers.modal.element),$(c.settings.container).show(),d.moduleLoaded.containers.modal.fadeIn(200),d.moduleLoaded.containers.modal.element.addClass("dinamic-modal")}if("delete"===b){if(!confirm(lang("Are you sure that want to delete this record?")))return!1}else("new"===b||"edit"===b)&&(c.containers.modal.fadeIn(200),c.containers.modal.element.scrollTop(0),c.containers.modal.element.css("z-index",modalIndex++));var l={};l[a.table_id]=e,ajax({url:BASE_URL+f,data:l,success:function(a){if(a.message&&(c.containers.modal.element.find(".modal-content").html(""),d.message.find(".title").text(a.message),c.containers.modal.element.find(".modal-content").append(d.message)),"new"===b)c.containers.form.loadData(a),c.containers.form.initAfterShow();else if("edit"===b)c.containers.form.loadData(a,"",c),c.containers.form.initAfterShow();else if("delete"===b)d.refresh();else if("load"===b)d.external.find("*").remove(),d.external.html(""),d.external.append(a),d.external.find(".grid-container").show(),d.element.hide(),d.external.show();else if("module"===b){var f=new Module(a[g]).init();moduleManager.modules[g]=f,f.containers.modal.element.find(".modal-header .title").text(a[g].containers.form.settings.title),f.containers.modal.element.find(".modal-content").append(f.containers.form.element),$(f.settings.container).append(f.element),f.containers.modal.fadeIn(200),f.containers.form.callbackAfterSend=function(){f.containers.modal.fadeOut(200)},f.containers.modal.element.on("click",function(a){a.target==f.containers.modal.element[0]&&f.containers.modal.fadeOut(200)}),f.inline={}}else if("add"===b){var i=d.actions[h];if(i.default){var j;for(var k in i.default)j=i.default[k],"row_id"===j&&(j=e),d.moduleLoaded.containers.modal.element.find("#"+i.model.table_name+"_"+k).val(j)}}},beforeSend:function(){}})},this.show=function(){d.external.hide(),d.element.show(),d.grid.show(),d.grid.find(".grid").show(),d.refresh()},this.cancel=function(){c.containers.form&&c.containers.modal&&c.containers.modal.fadeOut(200)},this},containers.inline=function(a,b,c,d,e){this.element=buildFromTemplate(a,"inline",b.grid.settings),this.grid=buildFromTemplate(a,"grid_inline",b.grid.settings),this.list=[],this.element.append(this.grid);var f=this;return this.init=function(){c.containers.form&&c.containers.modal&&(resetForm(c.containers.form.element,c.containers.form),c.containers.modal.element.hide(),c.containers.modal.element.find(".modal-content").append(c.containers.form.element),c.containers.form.callbackAfterSend=function(){return c.containers.modal.fadeOut(200),!1},c.containers.form.buttons.submit.unbind("click"),c.containers.form.buttons.submit.on("click",function(){if(c.containers.form.element.valid()){var b={};for(var g in c.containers.form.fields)b[g]=c.containers.form.fields[g].val();f.list.push(b),f.loadData(f,a,d,e),f.cancel()}return!1}),c.containers.form.buttons.cancel.on("click",function(){return c.containers.modal.fadeOut(200),!1}),c.containers.modal.element.on("click",function(a){a.target==c.containers.modal.element[0]&&c.containers.modal.fadeOut(200)})),f.header=buildFromTemplate(a,"thead"),f.header_row=buildFromTemplate(a,"tr");var b;for(var g in a.field_group.grid){var h=a.field_group.grid[g],i=a.fields[h];i&&(b=buildFromTemplate(a,"th"),b.text(i.name),f.header_row.append(b))}return b=buildFromTemplate(a,"th"),b.addClass("actions"),b.text(""),f.header_row.append(b),$(f.header).append(f.header_row),f.grid.append(f.header),f.tbody=buildFromTemplate(a,"tbody"),f.grid.append(f.tbody),f.message=buildFromTemplate(a,"message"),this},this.refreshOnly=function(){f.loadData(f,a,d,e)},this.loadData=function(a,b,d,e,g){a.tbody.find("*").remove(),a.tbody.html("");var h,i=d.model.fields[e],j=i.id?i.id:i.key;for(var k in a.list){var l=a.list[k],m=buildFromTemplate(b,"tr");m.attr("id",k);for(var n in b.field_group.grid){switch(column=b.field_group.grid[n],g=buildFromTemplate(b,"td"),b.fields[column].type){case"email":var o=buildFromTemplate("","a");o.attr("href","mailto:"+l[column]),o.text(l[column]),g.append(o);break;case"upload":var o=$("<img/>");o.attr("src",BASE_URL+"../helpers/timthumb.php?width=48&height=48&src="+b.fields[column].settings.download+l[column]),o.css("width",100),o.css("height","auto"),o.text(l[column]),g.append(o);break;default:g.text(l[column])}m.append(g)}l.deleted&&(h=buildFromTemplate(b,"hidden",i,i.key),h.removeAttr("id"),h.attr("name",d.model.table_name+"["+j+"]["+k+"][deleted]"),h.val("1"),g.append(h),m.addClass("deleted"));for(n in b.field_group.form){column=b.field_group.form[n];var p=b.fields[column];if("inline"===p.type)f.buildDepends(c.inline[column],p.model,b,column,g,d.model.table_name+"["+j+"]["+k+"]");else if("composite"===p.type){field_id=b.fields[column].id?b.fields[column].id:b.fields[column].key;for(var q in l[column])h=buildFromTemplate(b,"hidden",i,i.key),h.removeAttr("id"),h.attr("name",d.model.table_name+"["+j+"]["+k+"]["+field_id+"][]"),h.val(l[column][q]),g.append(h)}else field_id=b.fields[column].id?b.fields[column].id:b.fields[column].key,void 0!==field_id&&(h=buildFromTemplate(b,"hidden",i,i.key),h.removeAttr("id"),h.attr("name",d.model.table_name+"["+j+"]["+k+"]["+field_id+"]"),h.val(l[column]),g.append(h))}h=buildFromTemplate(b,"hidden",i,i.key),h.removeAttr("id"),h.attr("name",d.model.table_name+"["+j+"]["+k+"]["+d.model.table_name+"_id]"),h.val(d.containers.form.fields.id.val()),g.append(h),g=buildFromTemplate(b,"td"),g.addClass("actions");var r;l.id&&(r=buildFromTemplate(b,"button"),r.text(lang("Edit")),r.attr("rel",l.id),r.attr("action","edit"),r.on("click",f.actionButton),g.append(r)),l.deleted||(r=buildFromTemplate(b,"button"),r.text(lang("Delete")),r.attr("rel",k),r.attr("action","delete"),r.on("click",f.actionButton),g.append(r)),m.append(g),a.tbody.append(m)}},this.buildDepends=function(a,b,c,d,e,f){var g=c.fields[d],h=g.id?g.id:g.key;for(var i in a.containers.grid.list){var j=a.containers.grid.list[i];for(var k in b.field_group.form){column=b.field_group.form[k];var l=(b.fields[column],b.fields[column].id?b.fields[column].id:b.fields[column].key),m=buildFromTemplate(b,"hidden",g,g.key);m.removeAttr("id"),m.attr("name",f+"["+h+"]["+i+"]["+l+"]"),m.val(j[column]),e.append(m)}}},this.actionButton=function(){f.actionRow($(this).attr("action"),$(this).attr("rel"),$(this).attr("url"),$(this).attr("module"))},this.actionRow=function(b,g){for(var h in c.inline)c.inline[h].containers.grid.list=[],c.inline[h].containers.grid.refreshOnly();if(c.containers.form.element.find(".grid").show(),c.containers.modal.element.find(".modal-header .title").text(lang("New "+a.table_name)),c.containers.modal.element.find(".modal-content").append(c.containers.form.element),"new"===b){c.containers.modal.element.find(".modal-header .title").text(lang("New "+a.table_name)),c.containers.modal.element.scrollTop(0);for(var i in c.containers.form.fields)c.containers.form.fields[i].val("");resetForm(c.containers.form.element,c.containers.form),ajax({url:BASE_URL+a.base_url+a.table_name+"/getNew",success:function(a){c.containers.form.loadData(a)}}),c.containers.modal.fadeIn(200),c.containers.modal.element.scrollTop(0),$(window).scrollTop(0),c.containers.modal.element.css("z-index",modalIndex++),c.containers.form.buttons.submit.unbind("click").on("click",function(){if(c.containers.form.element.valid()){var b={};
for(var g in c.containers.form.fields)"composite"===a.fields[g].type?(b[g]=[],c.containers.form.fields[g].find("option").each(function(){this.selected===!0&&b[g].push(this.value)})):b[g]="upload"===a.fields[g].type?c.containers.form.fields[g][1].value:c.containers.form.fields[g].val();f.list.push(b),f.loadData(f,a,d,e),f.cancel()}})}else if("delete"===b)f.list[g].deleted=!0,f.refreshOnly();else if("edit"===b){c.containers.modal.element.find(".modal-header .title").text(lang("Edit "+a.table_name)),c.containers.modal.element.scrollTop(0),$(window).scrollTop(0),c.containers.modal.fadeIn(200),c.containers.modal.element.scrollTop(0),c.containers.modal.element.css("z-index",modalIndex++);var j={};j[a.table_id]=g,ajax({url:BASE_URL+a.base_url+a.table_name+"/getEdit",data:j,success:function(a){c.containers.form.loadData(a,!0,c)}}),c.containers.form.buttons.submit.unbind("click").on("click",function(){return c.containers.form.element.valid()&&ajax({url:BASE_URL+a.base_url+a.table_name+"/save",data:c.containers.form.element.serializeArray(),success:function(b){if("success"===b.status&&b[a.table_name]){var c=b[a.table_name].id;for(var g in f.list)if(f.list[g].id===c){for(var h in f.list[g])f.list[g][h]=b[a.table_name][h];break}}d.inline[e].containers.grid.refreshOnly(),f.cancel()}}),!1}),f.refreshOnly()}return!1},this.show=function(){f.element.show(),f.refresh()},this.cancel=function(){c.containers.modal.fadeOut(200)},this},containers.modal=function(a,b){this.element=buildFromTemplate(a,"modal",b.settings);var c=this;return this.init=function(){return this},this.fadeIn=function(){c.element.css("display","block"),c.element.addClass("shown")},this.fadeOut=function(){c.element.removeClass("shown"),c.element.css("display","none")},this},containers.toolbar=function(a,b,c){this.element=buildFromTemplate(a,"toolbar",b.grid.settings);var d=this;return this.fields={},this.init=function(){if(b.toolbar.settings&&b.toolbar.settings.actions){for(var e in b.toolbar.settings.actions){var f,g=b.toolbar.settings.actions[e];if("button"==g.type){var h=buildFromTemplate("","button");h.text(g.title),h.attr("action",g.action),"new"===g.action&&h.on("click",c.containers.grid.actionButton),d.element.append(h)}else"text"===g.type?(f=buildFromTemplate("",g.template),f.text(g.title),d.element.append(f)):"break"===g.type&&(f=buildFromTemplate("","div"),d.element.append(f))}c.containers.grid.element.prepend(d.element)}d.form=buildFromTemplate(a,"form");var i=0;for(var e in a.fields){var j=a.fields[e];if(j.filtrable){var k=buildFromTemplate(a,j.type,j,j.key);if(k.attr("name",a.table_name+"."+j.key),j.attr)for(var l in j.attr)k.attr(j.attr[l].name,j.attr[l].value);k.addClass("search"),d.form.append(k),d.fields[j.key]=k,i++}}return i>0&&(d.submit=buildFromTemplate(a,"submit"),d.submit.val(lang("Filter")),d.form.append(d.submit),d.submit.on("click",function(){var a=d.form.serializeArray(),b={};for(var e in a)b[a[e].name]=a[e].value;return c.containers.grid.data.filters=b,c.containers.grid.refresh(),!1}),ajax({url:BASE_URL+a.base_url+a.table_name+"/getNew",success:function(b){for(var c in d.fields){var e=d.fields[c];if("dropdown"==a.fields[c].type||"multiple"==a.fields[c].type||"composite"==a.fields[c].type){e.find("*").remove(),e.html("");for(var f in b[a.table_name].dropdown[c]){var g=b[a.table_name].dropdown[c][f],h=$("<option/>");h.attr("value",g.id),h.text(g.name),(g.selected||b[a.table_name][c]==g.id)&&h.attr("selected","selected"),e.append(h)}}}}})),d.element.append(d.form),this},this};var Module=function(a){this.settings=a.settings,this.element=buildFromTemplate(a.model,"module",a.settings),this.element.attr("id",a.model.table_name+"_container"),this.containers={},this.model=a.model;var b=this;this.init=function(){for(var c in a.containers)this.appendContainer(c,new containers[c](a.model,a.containers,b).init());return this},this.appendContainer=function(a,b){"toolbar"!=a&&this.element.append(b.element),this.containers[a]=b}},ModuleManager=function(){this.modules={};var a=this;this.init=function(b){for(var c in b){var d=new Module(b[c]).init();this.appendModule(c,d,d.settings),d.inline={},initInlineModules(d,d.settings)}if(sidebar&&sidebar.length>0){var e=$("#sidebar");for(c in sidebar){var f,g=sidebar[c];g.type?"menu"===g.type&&(f=buildFromTemplate("","sidebar_menu")):f=buildFromTemplate("","sidebar_row");var h=buildFromTemplate("","sidebar_arrow");f.find(".text").append(h),f.find(".text").text(g.title),f.attr("rel",g.module),f.find(".text").attr("rel",g.module).find("i").attr("rel",g.module),g.url&&(f.attr("url",g.url),f.find(".text").attr("url",g.url).find("i").attr("url",g.url)),e.append(f),f.bind("click",a.onRowSeleted)}}frameworkInit()},this.onRowSeleted=function(b){var c=$(b.target);a.sidebar_current_module=c.attr("rel"),$("#sidebar .menu").removeClass("active"),$("#page .grid-container, .external").hide(),c.parent().addClass("active"),c.addClass("active");var d=c.attr("url");return""===$.trim(d)?(moduleManager.modules[a.sidebar_current_module].containers.grid.show(),moduleManager.modules[a.sidebar_current_module].containers.grid.external.hide()):ajax({url:BASE_URL+d,success:function(b){var c=$(b);$("#"+a.sidebar_current_module+" *").remove(),$("#"+a.sidebar_current_module).html(c),c.show()}}),!1},this.appendModule=function(a,b,c){$(c.container).append(b.element),this.modules[modules[a].model.table_name]=b}};$(function(){moduleManager=new ModuleManager,moduleManager.init(modules)});